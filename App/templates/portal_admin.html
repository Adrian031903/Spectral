{% extends "layout.html" %}
{% block title %}Admin Portal{% endblock %}
{% block page %}Admin Portal{% endblock %}

{% block content %}
<div class="section">
  <h4>Admin Tools</h4>
  <p>Login as Admin to manage areas and streets. These call the existing admin APIs.</p>
  <div id="whoami" class="chip login-chip" style="display:none;"></div>
  <div id="alert" class="card-panel red lighten-4" style="display:none;"></div>
</div>

<div class="row">
  <div class="col s12 m6">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Create Area</span>
        <div class="input-field"><input id="area-name" type="text"><label for="area-name">Area name</label></div>
      </div>
      <div class="card-action">
        <button class="btn purple" id="btn-add-area">Add Area</button>
      </div>
    </div>
  </div>

  <div class="col s12 m6">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Create Street</span>
        <div class="input-field"><input id="street-name" type="text"><label for="street-name">Street name</label></div>
        <div class="input-field"><input id="street-area" type="number" min="1"><label for="street-area">Area ID</label></div>
      </div>
      <div class="card-action">
        <button class="btn purple" id="btn-add-street">Add Street</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col s12">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Browse</span>
        <p>List all areas and streets.</p>
      </div>
      <div class="card-action">
        <button class="btn grey" id="btn-list-areas">List Areas</button>
        <button class="btn grey" id="btn-list-streets">List Streets</button>
      </div>
      <ul class="collection aesthetic-list" id="admin-list"></ul>
    </div>
  </div>
</div>

<script>
function showToast(msg) { M.toast({html: msg}); }
function showAlert(msg) {
  const el = document.getElementById('alert');
  if (!el) return;
  if (!msg) { el.style.display='none'; return; }
  el.textContent = msg;
  el.style.display = 'block';
}

async function apiFetch(url, options = {}) {
  const res = await fetch(url, {credentials: 'same-origin', headers: {'Content-Type': 'application/json'}, ...options});
  if (!res.ok) {
    const body = await res.json().catch(() => ({}));
    const msg = body.error?.message || body.message || res.statusText;
    showAlert(msg);
    throw new Error(msg);
  }
  showAlert('');
  return res.json().catch(() => ({}));
}

async function loadWhoAmI() {
  const chip = document.getElementById('whoami');
  if (!chip) return;
  try {
    const data = await apiFetch('/api/identify');
    chip.textContent = `Logged in as ${data.message || data.username || 'Admin'}`;
    chip.style.display = 'inline-flex';
  } catch (e) {
    chip.textContent = 'Not logged in';
    chip.style.display = 'inline-flex';
  }
}

const list = document.getElementById('admin-list');

function renderItems(items) {
  list.innerHTML = '';
  if (!items || !items.length) {
    const li = document.createElement('li');
    li.className = 'collection-item aesthetic-item empty-state';
    li.textContent = 'No records yet. Create one to see it here.';
    list.appendChild(li);
    return;
  }

  items.forEach(i => {
    const li = document.createElement('li');
    li.className = 'collection-item aesthetic-item';
    const title = document.createElement('div');
    title.className = 'item-title';
    title.textContent = i.name || i.username || `Item ${i.id ?? ''}`;

    const meta = document.createElement('div');
    meta.className = 'item-meta';
    const pairs = Object.entries(i || {}).map(([k, v]) => `${k}: ${v}`);
    meta.textContent = pairs.join(' â€¢ ');

    li.appendChild(title);
    li.appendChild(meta);
    list.appendChild(li);
  });
}

document.getElementById('btn-add-area')?.addEventListener('click', async () => {
  const name = document.getElementById('area-name').value;
  if (!name) return showToast('Enter area name');
  try {
    await apiFetch('/admin/areas', {method: 'POST', body: JSON.stringify({name})});
    showToast('Area created');
  } catch (e) { showToast(e.message); }
});

document.getElementById('btn-add-street')?.addEventListener('click', async () => {
  const name = document.getElementById('street-name').value;
  const areaId = Number(document.getElementById('street-area').value);
  if (!name || !areaId) return showToast('Enter street name and area id');
  try {
    await apiFetch('/admin/streets', {method: 'POST', body: JSON.stringify({name, area_id: areaId})});
    showToast('Street created');
  } catch (e) { showToast(e.message); }
});

document.getElementById('btn-list-areas')?.addEventListener('click', async () => {
  try {
    const data = await apiFetch('/admin/areas');
    renderItems(data.items || []);
    showToast('Areas loaded');
  } catch (e) { showToast(e.message); }
});

document.getElementById('btn-list-streets')?.addEventListener('click', async () => {
  try {
    const data = await apiFetch('/admin/streets');
    renderItems(data.items || []);
    showToast('Streets loaded');
  } catch (e) { showToast(e.message); }
});

loadWhoAmI();

</script>
{% endblock %}
